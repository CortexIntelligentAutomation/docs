---
title: "Upgrade Loki"
linkTitle: "Upgrade Loki"
description: "The steps to upgrade Loki."
weight: 3
---

# {{% param title %}}

This guide describes how to upgrade the Loki installation. Please ensure that the [Grafana Upgrade] has been completed before starting this upgrade.

## Perform Upgrade

1. Log in to the server hosting your Loki service.
1. Run Windows PowerShell as Administrator.
1. Change the directory to the folder where Loki is running from, e.g. `cd C:\ProgramData\Cortex\Observability\Loki`.
1. Remove the current Loki installation by executing the following command:

    ``` powershell
        .\Remove-Loki.ps1
    ```

1. Click *Yes* when prompted for confirmation that you wish to remove the service.
1. Click *OK* when the successful removal of the Loki service is confirmed.
1. Open a File Explorer and navigate to the folder where Loki was running from, e.g. `C:\ProgramData\Cortex\Observability\Loki`.
1. Delete the following file from the directory:

    * loki-windows-amd64.exe

1. In File Explorer, navigate to the extracted `loki-windows-amd64.exe` folder created as part of [Make Artefacts Available][].
1. Copy the `loki-windows-amd64.exe` file into the folder that Loki was previously running from, e.g. `C:\ProgramData\Cortex\Observability\Loki`.
1. Run Windows PowerShell as Administrator.
1. Change the directory to the folder where the Loki file has been copied to, e.g. `cd C:\ProgramData\Cortex\Observability\Loki`.
1. Install Loki by executing the following command:

    ``` powershell
        .\Install-Loki.ps1
    ```

1. Start the Loki service by executing the following command:

    ``` powershell
        .\Start-Loki.ps1
    ```

1. Check that the Loki service has installed and started correctly:
    * Open Services.msc from the Start menu.
    * Locate the *Loki* service and confirm that it is *Running*.

## Make Reverse Proxy changes

### Disable Basic Authentication

1. Run IIS Manager.
1. In the *Connection* pane, browse to *Sites*.
1. Select the website for the Loki Reverse Proxy e.g. `Grafana Loki`.
1. Double-click on the *Authentication* icon.
1. Enable *Anonymous Authentication*.
1. Disable *Basic Authentication*.

### Configure URL Rewrite Rules

#### Set-up Authentication

1. Run IIS Manager.
1. In the *Connection* pane, browse to *Sites*.
1. Select the website for the Loki Reverse Proxy e.g. `Grafana Loki`.
1. Double-click on the *URL Rewrite* icon.
1. In the *Actions* pane, click *Add Rule(s)...*.
1. Select *Blank rule* from the *Inbound Rules* section.
1. Click *OK*.
1. In the *Edit Inbound Rule* Dialog:
    * Enter a *Name* for the rule, e.g. *Bearer Authentication*.
    * Configure the *Match URL* section:
        * *Requested URL* should be set to `Matches the Pattern`.
        * *Using* should be set to `Regular Expressions`.
        * *Pattern* should be set to `.*`.
        * *Ignore case* should be checked.
    * In the *Conditions* section:
        * *Logical Grouping* should be set to `Match Any`.
        * Click `Add...` to add a new condition.
        * In the *Edit Condition* dialog:
            * *Condition Input* should be set to `{HTTP_AUTHORIZATION}`.
            * *Check if input string:* should be set to `Does Not Match the Pattern`.
            * *Pattern* should be set to `^Bearer <Bearer Token>$` replacing &lt;Bearer Token&gt; with an appropriate value.

                A valid Bearer Token can be generated by any token generator, e.g. [Token Generator][], and should be a minimum of 64 characters consisting of uppercase and lowercase letters as well as numbers but should not contain any symbols. This token value should be saved for use when [Migrating Promtail to Grafana Alloy][Migrate to Alloy].
            * *Ignore case* should be unchecked.
            * Click `OK`.
    * In the *Action* section:
        * *Action Type* should be set to `Custom Response`.
        * *Action Properties* should be configured as follows:
            * *Status code* should be set to `401`.
            * *Reason* should be set to `Unauthorised`.
            * *Error description* should be set to `Invalid Bearer Token`.
1. In the *Actions* pane, click *Apply*.

#### Ensure Correct Ordering of URL Rewrite Rules

The URL Rewrite rules should be in the following order:

1. Bearer Authentication
2. ReverseProxyInboundRule

If the order is incorrect:

1. Select the *Bearer Authentication* rule.
1. In the *Actions* pane, click *Move Up*.
1. If prompted that inheritance will be affected, click *Yes*.

### Restart the Website

1. Run IIS Manager.
1. In the *Connection* pane, browse to *Sites*.
1. Select the website for the Loki Reverse Proxy e.g. `Grafana Loki`.
1. In the *Manage Website* pane, click *Restart*.

## Next Steps?

1. [Migrate Promtail to Grafana Alloy][Migrate to Alloy]

[backed up]: {{< url path="Cortex.Guides.UpgradeGuides.UpgradeObservability.3.0.0to4.0.0.OnPremise.Grafana.BackupOldFiles" >}}
[Grafana Upgrade]: {{< url path="Cortex.Guides.UpgradeGuides.UpgradeObservability.3.0.0to4.0.0.OnPremise.Grafana.UpgradeGrafana" >}}
[Make Artefacts Available]: {{< url path="Cortex.Guides.UpgradeGuides.UpgradeObservability.3.0.0to4.0.0.OnPremise.Grafana.MakeArtefactsAvailable" >}}
[Migrate to Alloy]: {{< url path="Cortex.Guides.UpgradeGuides.UpgradeObservability.3.0.0to4.0.0.OnPremise.Grafana.MigrateToAlloy" >}}
[Token Generator]:  {{< url path="IT-Tools.TokenGenerator" >}}
